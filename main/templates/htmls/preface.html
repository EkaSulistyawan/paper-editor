<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Media Context</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .media-img {
        width: 150px;
        height: 150px;
        object-fit: cover;
        cursor: pointer;
        margin: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        position: relative;
    }
    .remove-btn {
        position: absolute;
        top: 2px;
        right: 2px;
        font-size: 18px;
        color: red;
        background: white;
        border-radius: 50%;
        padding: 2px 6px;
        cursor: pointer;
        z-index: 10;
    }
    .reference-remove {
        color: red;
        cursor: pointer;
        margin-left: 10px;
    }
  </style>
</head>
<body class="p-4">

<div class="container">
    <!-- Figures Section -->
    <h3>Figures found in your media directory</h3>
    <p>Criteria: Click to large preview, remove icon</p>
    <div class="d-flex flex-wrap" id="images-container">
        {% for img in media_images %}
            <div class="position-relative" style="display:inline-block;">
                <span class="remove-btn" onclick="removeImage('{{ img }}')">&times;</span>
                <img src="{{ MEDIA_URL }}{{ img }}" class="media-img" alt="{{ img }}" 
                 onclick="openPreview('{{ MEDIA_URL }}{{ img }}')" 
                 data-bs-toggle="tooltip" title="{{ img }}"><div class="small text-truncate" style="max-width:150px;">{{ img }}</div>
            </div>
        {% empty %}
            <p>No figures found.</p>
        {% endfor %}
    </div>

    <div class="mt-4">
        <p>Didn't find your figure? Upload here!</p>
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="file" name="figure" class="form-control mb-2">
            <button type="submit" class="btn btn-primary">Upload</button>
        </form>
    </div>

    <!-- References Section -->
     <div class="mt-5">
    <h3>References</h3>
    <p>Edit your references below and save. Preview shows current content.</p>

    <!-- Load & Save Form -->
    <form method="POST" action="{% url 'save_reference' %}">
        {% csrf_token %}
        <!-- Textarea for preview/edit -->
        <textarea class="form-control mb-2" name="references_text" rows="10">{{ references_text }}</textarea>
        <button type="submit" class="btn btn-success">Save References</button>
    </form>

    <!-- Upload new references file -->
    <div class="mt-3">
        <p>Upload new references file (.txt) to replace current one:</p>
        <form method="POST" action="{% url 'upload_reference' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="file" name="reference" class="form-control mb-2" accept=".txt">
            <button type="submit" class="btn btn-primary">Upload</button>
        </form>
    </div>
</div>
</div>

<script>
function openPreview(src) {
    window.open(src, '_blank', 'width=800,height=600');
}

function removeImage(filename) {
    if (!confirm('Remove "' + filename + '" from media directory?')) return;

    fetch("{% url 'remove_image' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({ filename: filename })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const imagesContainer = document.getElementById('images-container');
            const imgDivs = imagesContainer.querySelectorAll('div.position-relative');
            imgDivs.forEach(div => {
                const img = div.querySelector('img');
                if (img.alt === filename) div.remove();
            });
        } else {
            alert('Failed to remove image');
        }
    });
}


</script>

</body>
</html>
