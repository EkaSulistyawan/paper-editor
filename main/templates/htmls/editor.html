<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Paper Editor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-5">

<div class="container">
  <h2 class="mb-4">Paper Editor</h2>

  <form method="POST">
    {% csrf_token %}

    <!--Heading selects-->
    <label for="headingSelect">Choose Heading:</label>
    <select name="heading" id="headingSelect" class="form-select">
      {% for h in headings %}
        <option value="{{ h.title }}"
          {% if entry.heading == h.title %}selected{% endif %}>{{ h.title }}</option>
        {% for sub1 in h.sub %}
          <option value="{{ sub1.title }}" {% if entry.heading == sub1.title %}selected{% endif %}>
            &nbsp;&nbsp;{{ sub1.title }}
          </option>
          {% for sub2 in sub1.sub %}
            <option value="{{ sub2.title }}" {% if entry.heading == sub2.title %}selected{% endif %}>
              &nbsp;&nbsp;&nbsp;&nbsp;{{ sub2.title }}
            </option>
          {% endfor %}
        {% endfor %}
      {% endfor %}
    </select>
    <!-- Paragraph -->
    <div class="mb-3">
      <label class="form-label">Paragraph</label>
      <textarea name="paragraph" class="form-control" rows="6">{{ entry.paragraph }}</textarea>
    </div>

    <!-- Figures -->
    <div class="d-flex flex-wrap gap-3">
      {% for img in media_images %}
        <div class="form-check text-center" style="width:150px;">
          <input class="form-check-input image-checkbox" type="checkbox" value="{{ img }}"
            id="img{{ forloop.counter }}" {% if img in entry.images %}checked{% endif %}>
          <label class="form-check-label" for="img{{ forloop.counter }}">
            <a href="{{ MEDIA_URL }}{{ img }}" target="_blank">
              <img src="{{ MEDIA_URL }}{{ img }}" class="img-fluid rounded" alt="figure">
            </a>
          </label>
        </div>
      {% endfor %}
    </div>

    <!-- References -->
    <div class="mb-3">
      <label class="form-label">References</label>
      <textarea name="references" class="form-control" rows="3">{{ entry.references }}</textarea>
    </div>

    <!-- Hidden inputs to submit selected images -->
    <div id="hiddenImages"></div>

    <!-- Navigation -->
    <div class="d-flex justify-content-between">
      <button type="submit" name="action" value="previous" class="btn btn-secondary">Previous</button>
      <a href="/manage/" class="btn btn-warning">Manage Environment (Images, Headings)</a>
      <button id="previewBtn" class="btn btn-warning">Preview</button>
      <button id="aiCommentBtn" type="button" class="btn btn-warning">Hey AI! Comment my paper!</button>
      <button type="submit" name="action" value="next" class="btn btn-primary">Next</button>
    </div>
    <p class="text-muted mt-2">Step {{ index|add:1 }} / {{ total }}</p>
  </form>
  <!-- Placeholder for AI comment -->
  <div id="aiCommentBox" class="mt-3 border p-3 bg-light" style="display:none;"></div>
      

</div>

<script>
const checkboxes = document.querySelectorAll('.image-checkbox');
const hiddenImages = document.getElementById('hiddenImages');

function updateHiddenInputs() {
  hiddenImages.innerHTML = '';
  checkboxes.forEach(cb => {
    if(cb.checked){
      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.name = 'selected_images';
      hidden.value = cb.value;
      hiddenImages.appendChild(hidden);
    }
  });
}

// Update hidden inputs on load
updateHiddenInputs();

// Update hidden inputs whenever a checkbox is clicked
checkboxes.forEach(cb => cb.addEventListener('change', updateHiddenInputs));
</script>

<script>
document.getElementById("aiCommentBtn").addEventListener("click", async function(){
  const paragraph = document.querySelector('textarea[name="paragraph"]').value;
  const reference = document.querySelector('textarea[name="references"]').value;

  if(!paragraph.trim()){
    alert("Please enter a paragraph first!");
    return;
  }

  const response = await fetch("{% url 'ai_recommendation' %}", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": "{{ csrf_token }}",
    },
    body: JSON.stringify({ paragraph: paragraph, reference: reference})
  });

  const data = await response.json();
  const box = document.getElementById("aiCommentBox");
  box.style.display = "block";
  box.textContent = data.comment;
});
</script>

<script>
let previewWindow;

document.getElementById("previewBtn").addEventListener("click", function(e){
    e.preventDefault();
    const url = "/preview/";  // your preview URL

    if (!previewWindow || previewWindow.closed) {
        previewWindow = window.open(url, "previewWindow", "width=900,height=700");
    } else {
        previewWindow.focus();
    }
});
</script>

</body>
</html>
